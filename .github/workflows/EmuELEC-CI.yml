#
# This is free software.
# 

name: EmuELEC-CI

on:
  watch:
    types: started
  push:
    tags:
        -.*
    # branches: 
        # - master
  # schedule:
    # - cron: 0 20 * * *
  # release:
    # types: [published]
      
env:
  SSH_ACTIONS: false

jobs:

  build_emuelec:

    name: Build EmuELEC
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: SSH connection to Actions
        uses: P3TERX/debugger-action@main
        if: env.SSH_ACTIONS == 'true' || contains(github.event.action, 'ssh')
        
      - name: Checkout
        uses: actions/checkout@master
        with:
          ref: master
      
      - name: Prepare
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
            df -h
            docker rmi `docker images -q`
            sudo rm -rf /usr/share/dotnet /var/lib/mysql /etc/php /etc/apt/sources.list.d
            sudo -E apt-get remove ansible* azure* aws* swift* podman* docker* skopeo* dotnet* erlang* firefox* google* gecko* chrome* cabal* ghc* haskell* hhvm* azul* adopt* ant* gradle* maven* kind* kubectl* helm* mono* mysql* php* psql* swig* mongodb* android*
            sudo -E apt-get -y autoremove --purge            
            sudo -E apt update && sudo apt upgrade
            sudo -E apt-get -y install gcc make git unzip wget xz-utils libsdl2-dev libsdl2-mixer-dev libfreeimage-dev libfreetype6-dev libcurl4-openssl-dev rapidjson-dev libasound2-dev libgl1-mesa-dev build-essential libboost-all-dev cmake fonts-droid-fallback libvlc-dev libvlccore-dev vlc-bin texinfo premake4 golang bc patchutils gperf lzop xfonts-utils xsltproc libjson-perl 
            #bc lsdiff gperf lzop mkfontscale mkfontdir bdftopcf xsltproc perl
            #sudo -E apt-get -y autoremove --purge
            sudo -E apt-get clean
            df -h
          
      - name: Compile firmware
        run: |
          PROJECT=Amlogic-ng ARCH=arm DISTRO=EmuELEC make image

      - name: Check space usage
        if: (!cancelled())
        run: df -hT

      - name: Upload firmware
        uses: actions/upload-artifact@master
        with:
          name: EmuELEC
          path: ./repo
